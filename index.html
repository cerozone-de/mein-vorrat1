<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<meta name="theme-color" content="#1a3d2b">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Mein Vorrat">
<title>Mein Vorrat</title>
<link rel="manifest" id="manifest-placeholder">

<style>
@import url('https://fonts.googleapis.com/css2?family=Fraunces:wght@600;700&family=DM+Sans:wght@400;500;600;700&display=swap');

:root {
  --bg: #FDF6EE;
  --surface: #FFFFFF;
  --green: #2B5C3F;
  --green-mid: #3D7A57;
  --green-light: #6BBF87;
  --amber: #C4711A;
  --amber-light: #F0A844;
  --red: #C0392B;
  --text: #1A1A1A;
  --muted: #888;
  --border: #EAE0D5;
  --shadow: 0 1px 6px rgba(0,0,0,0.06), 0 4px 16px rgba(0,0,0,0.04);
  --shadow-lg: 0 8px 32px rgba(0,0,0,0.10);
  --r: 16px;
  --nav: 68px;
  --font-head: 'Fraunces', serif;
  --font-body: 'DM Sans', sans-serif;
}
[data-dark="1"] {
  --bg: #141A16;
  --surface: #1E2820;
  --green: #6BBF87;
  --green-mid: #88D4A0;
  --green-light: #A8E4BC;
  --amber: #F0A844;
  --amber-light: #F8C87A;
  --red: #E06B6B;
  --text: #EDF2EF;
  --muted: #90A89A;
  --border: #2C3C32;
  --shadow: 0 1px 6px rgba(0,0,0,0.3), 0 4px 16px rgba(0,0,0,0.2);
}
/* Dark mode status badges */
[data-dark="1"] .s-ok{background:#1E3A28;color:#6BBF87}
[data-dark="1"] .s-low{background:#3A2E0E;color:#F0A844}
[data-dark="1"] .s-empty{background:#3A1414;color:#E06B6B}
[data-dark="1"] .s-a .snum{color:#6BBF87}
[data-dark="1"] .s-l .snum{color:#F0A844}
[data-dark="1"] .s-e .snum{color:#E06B6B}
[data-dark="1"] .conn-ok{background:#1E3A28;color:#6BBF87}
[data-dark="1"] .conn-err{background:#3A1414;color:#E06B6B}
[data-dark="1"] .sok{background:#1E3A28}
[data-dark="1"] .slow{background:#3A2E0E}
[data-dark="1"] .sgone{background:#3A1414}

*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden;font-family:var(--font-body);background:var(--bg);color:var(--text)}
#app{height:100dvh;display:flex;flex-direction:column;overflow:hidden}

/* HEADER */
.hdr{background:var(--green);color:#fff;padding:14px 18px 12px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;position:relative}
.hdr::after{content:'';position:absolute;bottom:-1px;left:0;right:0;height:1px;background:rgba(255,255,255,.1)}
.hdr-title{font-family:var(--font-head);font-size:22px;font-weight:700;letter-spacing:-.3px}
.hdr-sub{font-size:11px;opacity:.6;margin-top:2px;font-weight:500}
.hdr-actions{display:flex;gap:8px;align-items:center}
.hdr-btn{background:rgba(255,255,255,.15);border:none;color:#fff;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:17px;flex-shrink:0;transition:background .15s}
.hdr-btn:active{background:rgba(255,255,255,.3)}
.sync-dot{width:8px;height:8px;border-radius:50%;background:#6BBF87;flex-shrink:0;transition:background .3s}
.sync-dot.syncing{background:var(--amber-light);animation:pulse 1s infinite}
.sync-dot.err{background:var(--red)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

/* VIEWS */
.view{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:16px 14px calc(var(--nav) + 16px);display:none}
.view.active{display:block}

/* BOTTOM NAV */
.bnav{height:var(--nav);background:var(--surface);border-top:1px solid var(--border);display:flex;position:fixed;bottom:0;left:0;right:0;z-index:100;padding-bottom:env(safe-area-inset-bottom)}
.ni{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;cursor:pointer;border:none;background:none;color:var(--muted);font-family:var(--font-body);font-size:10px;font-weight:600;position:relative;transition:color .15s}
.ni.active{color:var(--green)}
.ni.active::after{content:'';position:absolute;top:0;left:20%;right:20%;height:2px;background:var(--green);border-radius:0 0 2px 2px}
.ni-icon{font-size:22px}

/* CARDS */
.card{background:var(--surface);border-radius:var(--r);padding:16px;box-shadow:var(--shadow);margin-bottom:12px;border:1px solid var(--border)}
.sec-title{font-family:var(--font-head);font-size:18px;font-weight:600;margin-bottom:12px;color:var(--green)}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:7px;padding:12px 20px;border-radius:12px;border:none;font-family:var(--font-body);font-size:14px;font-weight:600;cursor:pointer;transition:transform .1s,opacity .15s;touch-action:manipulation}
.btn:active{transform:scale(.96);opacity:.85}
.btn:disabled{opacity:.45;cursor:not-allowed}
.btn-p{background:var(--green);color:#fff}
.btn-a{background:var(--amber);color:#fff}
.btn-g{background:transparent;color:var(--green);border:2px solid var(--green)}
.btn-r{background:var(--red);color:#fff}
.btn-w{width:100%}
.btn-s{padding:8px 14px;font-size:12px;border-radius:9px}

/* STATUS BADGES */
.sbadge{display:inline-flex;align-items:center;gap:3px;padding:2px 9px;border-radius:20px;font-size:11px;font-weight:700}
.s-ok{background:#DCF2E4;color:#1A5C2A}
.s-low{background:#FEF3CC;color:#6B4400}
.s-empty{background:#FDDCDC;color:#7A1A1A}

/* PANTRY ITEM */
.icard{background:var(--surface);border-radius:var(--r);padding:13px 14px;box-shadow:var(--shadow);margin-bottom:9px;display:flex;align-items:center;gap:12px;transition:opacity .2s;border:1px solid var(--border)}
.icard.updating{opacity:.5}
.iicon{width:44px;height:44px;border-radius:12px;background:var(--bg);display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0}
.iinfo{flex:1;min-width:0}
.iname{font-weight:700;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:var(--text)}
.imeta{font-size:11px;color:var(--muted);margin-top:3px;display:flex;align-items:center;gap:5px;flex-wrap:wrap}
.iactions{display:flex;gap:5px;flex-shrink:0}
.sbtn{width:31px;height:31px;border-radius:8px;border:none;display:flex;align-items:center;justify-content:center;font-size:13px;cursor:pointer;transition:transform .1s}
.sbtn:active{transform:scale(.85)}
.sok{background:#DCF2E4}.slow{background:#FEF3CC}.sgone{background:#FDDCDC}

/* FILTER CHIPS */
.chips{display:flex;gap:7px;overflow-x:auto;padding-bottom:4px;margin-bottom:14px;scrollbar-width:none}
.chips::-webkit-scrollbar{display:none}
.chip{flex-shrink:0;padding:6px 14px;border-radius:20px;font-size:12px;font-weight:600;border:1.5px solid var(--border);background:var(--surface);color:var(--muted);cursor:pointer;transition:all .15s}
.chip.active{background:var(--green);color:#fff;border-color:var(--green)}

/* STATS */
.stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:14px}
.scard{background:var(--surface);border-radius:14px;padding:12px;text-align:center;box-shadow:var(--shadow);border:1px solid var(--border)}
.snum{font-family:var(--font-head);font-size:26px;font-weight:700}
.slabel{font-size:10px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:.4px;margin-top:1px}
.s-a .snum{color:#1A5C2A}.s-l .snum{color:#6B4400}.s-e .snum{color:#7A1A1A}

/* SHOPPING */
.shoprow{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid var(--border)}
.shoprow:last-child{border-bottom:none}
.shopcheck{width:24px;height:24px;border-radius:7px;border:2px solid var(--green-mid);display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;transition:all .15s;font-size:12px}
.shopcheck.checked{background:var(--green-mid);border-color:var(--green-mid);color:#fff}
.shopname{flex:1;font-weight:600;font-size:14px;color:var(--text)}
.shopname.done{text-decoration:line-through;color:var(--muted)}

/* INPUT */
.inp{width:100%;padding:12px 14px;border:1.5px solid var(--border);border-radius:12px;font-family:var(--font-body);font-size:14px;background:var(--bg);color:var(--text);outline:none;transition:border-color .15s;margin-bottom:11px}
.inp:focus{border-color:var(--green-mid)}
select.inp{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23888' stroke-width='2' fill='none'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 13px center;padding-right:34px}
.flabel{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:5px;display:block}

/* MODAL */
.moverlay{position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:200;display:none;align-items:flex-end;backdrop-filter:blur(2px)}
.moverlay.open{display:flex}
.msheet{background:var(--surface);border-radius:22px 22px 0 0;width:100%;max-height:90vh;overflow-y:auto;padding:20px 18px;animation:slideUp .24s cubic-bezier(.2,.8,.3,1)}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.mhandle{width:40px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 18px}

/* SCAN */
.scanbox{background:linear-gradient(135deg,var(--green) 0%,var(--green-mid) 100%);border-radius:var(--r);padding:24px;text-align:center;margin-bottom:14px}
.scanicon{font-size:54px;margin-bottom:10px}
.scantitle{color:#fff;font-size:18px;font-weight:700;margin-bottom:5px;font-family:var(--font-head)}
.scansub{color:rgba(255,255,255,.75);font-size:12px;line-height:1.5}
#cameraPreview{width:100%;border-radius:12px;max-height:260px;object-fit:cover;display:none;margin-bottom:10px}
#capturedCanvas{width:100%;border-radius:12px;max-height:260px;object-fit:cover;display:none;margin-bottom:10px}
.progbar{height:5px;background:var(--border);border-radius:3px;overflow:hidden;margin:10px 0}
.progfill{height:100%;background:var(--green-light);border-radius:3px;transition:width .3s}
.ocrrow{display:flex;align-items:center;gap:9px;padding:9px 0;border-bottom:1px solid var(--border)}
.ocrrow:last-child{border-bottom:none}
.ocrtog{width:22px;height:22px;border-radius:6px;border:2px solid var(--green-mid);display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;transition:all .15s;font-size:11px}
.ocrtog.sel{background:var(--green-mid);color:#fff;border-color:var(--green-mid)}
.ocrname input{border:none;background:none;font-family:var(--font-body);font-size:13px;font-weight:600;width:100%;outline:none;color:var(--text)}

/* REMINDER DAYS */
.daygrid{display:grid;grid-template-columns:repeat(7,1fr);gap:5px;margin-bottom:12px}
.daybtn{aspect-ratio:1;border-radius:9px;border:1.5px solid var(--border);background:var(--surface);font-size:10px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;color:var(--text)}
.daybtn.sel{background:var(--green);color:#fff;border-color:var(--green)}

/* TOAST */
.toast{position:fixed;bottom:calc(var(--nav) + 12px);left:14px;right:14px;background:var(--green);color:#fff;padding:12px 16px;border-radius:14px;font-weight:700;font-size:13px;z-index:300;transform:translateY(110px);opacity:0;transition:all .24s cubic-bezier(.2,.8,.3,1);text-align:center;box-shadow:var(--shadow-lg)}
.toast.show{transform:translateY(0);opacity:1}

/* EMPTY STATE */
.empty{text-align:center;padding:48px 24px;color:var(--muted)}
.empty-i{font-size:48px;margin-bottom:12px}

/* FAB */
#fab{position:fixed;bottom:calc(var(--nav) + 14px);right:14px;z-index:50;width:52px;height:52px;border-radius:50%;background:var(--green);color:#fff;border:none;font-size:28px;cursor:pointer;box-shadow:0 4px 20px rgba(43,92,63,.4);display:none;align-items:center;justify-content:center;transition:transform .15s}
#fab:active{transform:scale(.9)}

/* SETUP */
.setup-wrap{padding:28px 18px 100px;overflow-y:auto;height:100%}
.setup-hero{text-align:center;margin-bottom:28px}

/* INFO BOX */
.info{background:var(--bg);border:1.5px solid var(--border);border-radius:12px;padding:13px 14px;font-size:12px;color:var(--muted);line-height:1.6;margin-bottom:11px}
.info strong{color:var(--text)}
.info a{color:var(--green-mid);font-weight:700}

/* STEP */
.step{display:flex;gap:12px;margin-bottom:14px;align-items:flex-start}
.stepnum{width:26px;height:26px;border-radius:50%;background:var(--green);color:#fff;font-size:12px;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px}
.steptxt{font-size:13px;line-height:1.5;color:var(--text)}
.steptxt strong{color:var(--green)}
.steptxt a{color:var(--green-mid);font-weight:700}

/* STORES */
.strow{display:flex;align-items:center;gap:9px;padding:9px 0;border-bottom:1px solid var(--border)}
.strow:last-child{border-bottom:none}
.stdot{width:9px;height:9px;border-radius:50%;flex-shrink:0}

/* URL box */
.urlbox{background:var(--bg);border-radius:10px;padding:11px;font-size:11px;word-break:break-all;color:var(--muted);margin-bottom:11px;line-height:1.5;font-family:monospace}

/* CONNECTION status */
.conn-ok{background:#DCF2E4;color:#1A5C2A;border-radius:10px;padding:10px 13px;font-size:12px;font-weight:700;display:flex;align-items:center;gap:7px;margin-bottom:11px}
.conn-err{background:#FDDCDC;color:#7A1A1A;border-radius:10px;padding:10px 13px;font-size:12px;font-weight:700;display:flex;align-items:center;gap:7px;margin-bottom:11px}
</style>
</head>
<body>
<div id="app">

<!-- HEADER -->
<div class="hdr" id="hdr" style="display:none">
  <div>
    <div class="hdr-title">ü•ò Mein Vorrat</div>
    <div class="hdr-sub" id="hdrSub">Lade‚Ä¶</div>
  </div>
  <div class="hdr-actions">
    <div class="sync-dot" id="syncDot" title="Sync-Status"></div>
    <button class="hdr-btn" id="darkBtn" onclick="toggleDark()" title="Dunkelmodus">üåô</button>
  <button class="hdr-btn" id="hdrBtn">‚öôÔ∏è</button>
  </div>
</div>

<!-- ‚îÄ‚îÄ SETUP ‚îÄ‚îÄ -->
<div class="view active" id="view-setup">
  <div class="setup-wrap">
    <div class="setup-hero">
      <div style="font-size:60px;margin-bottom:13px">ü•ò</div>
      <div style="font-family:var(--font-head);font-size:24px;font-weight:700;color:var(--green);margin-bottom:6px">Mein Vorrat</div>
      <div style="color:var(--muted);font-size:13px;line-height:1.5">Familien-Vorrats-Tracker mit Google Sheets.<br>Kein Abo ¬∑ Keine Limits ¬∑ Kein Login n√∂tig.</div>
    </div>

    <div class="card">
      <div class="sec-title">üîß Einrichtung</div>

      <div class="step">
        <div class="stepnum">1</div>
        <div class="steptxt">Gehe zu <a href="https://sheets.google.com" target="_blank">sheets.google.com</a> ‚Üí Neue Tabelle erstellen ‚Üí gib ihr einen Namen (z.B. <strong>Mein Vorrat</strong>)</div>
      </div>
      <div class="step">
        <div class="stepnum">2</div>
        <div class="steptxt">In der Tabelle: Men√º <strong>Erweiterungen ‚Üí Apps Script</strong></div>
      </div>
      <div class="step">
        <div class="stepnum">3</div>
        <div class="steptxt">Den kompletten Inhalt aus <strong>Code.gs</strong> (die andere heruntergeladene Datei) hineinkopieren ‚Üí üíæ Speichern</div>
      </div>
      <div class="step">
        <div class="stepnum">4</div>
        <div class="steptxt">Klicke auf <strong>Bereitstellen ‚Üí Neue Bereitstellung</strong> ‚Üí Typ: <strong>Web App</strong><br>Ausf√ºhren als: <strong>Ich</strong><br>Zugriff: <strong>Jeder</strong> ‚Üí Bereitstellen</div>
      </div>
      <div class="step">
        <div class="stepnum">5</div>
        <div class="steptxt">Kopiere die angezeigte <strong>Web App URL</strong> und f√ºge sie unten ein</div>
      </div>

      <label class="flabel" style="margin-top:5px">Web App URL</label>
      <input type="url" class="inp" id="scriptUrl" placeholder="https://script.google.com/macros/s/‚Ä¶/exec" autocomplete="off">
      <div id="connStatus"></div>
      <button class="btn btn-p btn-w" onclick="doConnect()">üîó Verbinden & loslegen</button>
    </div>

    <button class="btn btn-w" style="background:transparent;color:var(--muted);border:2px solid var(--border);margin-top:4px" onclick="doOffline()">
      üì± Nur auf diesem Ger√§t (kein Teilen)
    </button>
  </div>
</div>

<!-- ‚îÄ‚îÄ PANTRY ‚îÄ‚îÄ -->
<div class="view" id="view-pantry">
  <div class="stats">
    <div class="scard s-a"><div class="snum" id="sOk">0</div><div class="slabel">Vorhanden</div></div>
    <div class="scard s-l"><div class="snum" id="sLow">0</div><div class="slabel">Wenig</div></div>
    <div class="scard s-e"><div class="snum" id="sEmpty">0</div><div class="slabel">Leer</div></div>
  </div>
  <div class="chips" id="chips"></div>
  <div id="pantryList"></div>
</div>
<button id="fab">+</button>

<!-- ‚îÄ‚îÄ SCAN ‚îÄ‚îÄ -->
<div class="view" id="view-scan">
  <div class="scanbox">
    <div class="scanicon">üìÑ</div>
    <div class="scantitle">Kassenbon scannen</div>
    <div class="scansub">Fotografiere deinen Bon ‚Äì die App erkennt alle Produkte automatisch</div>
  </div>
  <div class="card" id="scanCard">
    <canvas id="capturedCanvas"></canvas>
    <video id="cameraPreview" playsinline autoplay muted></video>
    <div id="scanBtns" style="display:flex;flex-direction:column;gap:9px">
      <button class="btn btn-p btn-w" id="camBtn">üì∑ Kamera √∂ffnen</button>
      <button class="btn btn-g btn-w" id="fileBtn">üìÅ Bild aus Galerie</button>
      <input type="file" id="fileInp" accept="image/*" style="display:none">
    </div>
    <div id="camCtrl" style="display:none;margin-top:10px">
      <button class="btn btn-a btn-w" id="snapBtn">üì∏ Foto aufnehmen</button>
      <button class="btn btn-g btn-w" style="margin-top:8px" id="camCancelBtn">Abbrechen</button>
    </div>
    <div id="ocrProg" style="display:none;margin-top:14px">
      <div style="text-align:center;color:var(--muted);font-size:13px;font-weight:700;margin-bottom:7px" id="ocrTxt">üîç Analysiere‚Ä¶</div>
      <div class="progbar"><div class="progfill" id="ocrFill" style="width:0%"></div></div>
    </div>
  </div>
  <div id="ocrResults" style="display:none">
    <div class="card">
      <div class="sec-title">‚úÖ Erkannte Produkte</div>
      <p style="font-size:12px;color:var(--muted);margin-bottom:11px">W√§hle aus, was du hinzuf√ºgen m√∂chtest. Namen kannst du direkt bearbeiten.</p>
      <label class="flabel">Laden</label>
      <select class="inp" id="ocrStore"></select>
      <div id="ocrList"></div>
      <div style="display:flex;gap:8px;margin-top:14px">
        <button class="btn btn-g" style="flex:1" id="ocrCancel">Abbrechen</button>
        <button class="btn btn-p" style="flex:1" id="ocrAdd">Hinzuf√ºgen</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ SHOPPING ‚îÄ‚îÄ -->
<div class="view" id="view-shopping">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:13px">
    <div class="sec-title" style="margin:0">üõçÔ∏è Einkaufsliste</div>
    <button class="btn btn-s btn-g" id="clearChecked">Erledigte weg</button>
  </div>
  <div class="card" style="margin-bottom:11px">
    <div style="display:flex;gap:7px;flex-wrap:wrap">
      <button class="btn btn-s" id="fAll" style="background:#e8f4f0;color:var(--green)">Alle</button>
      <button class="btn btn-s btn-g" id="fLow">‚ö†Ô∏è Wenig</button>
      <button class="btn btn-s btn-g" id="fEmpty">üî¥ Leer</button>
    </div>
  </div>
  <div id="shopList"></div>
  <button class="btn btn-p btn-w" style="margin-top:6px" id="shareListBtn">üì§ Liste teilen</button>
</div>

<!-- ‚îÄ‚îÄ MORE ‚îÄ‚îÄ -->
<div class="view" id="view-more">
  <!-- Verbindung -->
  <div class="card">
    <div class="sec-title">üîó Google Sheets Verbindung</div>
    <div id="connInfo" style="margin-bottom:11px"></div>
    <div style="display:flex;gap:7px;flex-wrap:wrap">
      <button class="btn btn-s btn-p" id="syncNowBtn">üîÑ Jetzt sync</button>
      <button class="btn btn-s btn-g" id="copyShareBtn">üìã Link kopieren</button>
      <button class="btn btn-s" style="background:var(--bg);border:2px solid var(--border);color:var(--muted)" id="disconnBtn">Trennen</button>
    </div>
  </div>

  <!-- Reminder -->
  <div class="card">
    <div class="sec-title">üîî Erinnerungen</div>
    <p style="font-size:12px;color:var(--muted);margin-bottom:13px">An welchen Tagen soll dich die App erinnern?</p>
    <label class="flabel">Wochentage</label>
    <div class="daygrid" id="dayGrid">
      <div class="daybtn" data-d="1">Mo</div>
      <div class="daybtn" data-d="2">Di</div>
      <div class="daybtn" data-d="3">Mi</div>
      <div class="daybtn" data-d="4">Do</div>
      <div class="daybtn" data-d="5">Fr</div>
      <div class="daybtn" data-d="6">Sa</div>
      <div class="daybtn" data-d="0">So</div>
    </div>
    <label class="flabel">Uhrzeit</label>
    <input type="time" class="inp" id="timeInp" value="09:00">
    <button class="btn btn-p btn-w" id="saveRemBtn">üíæ Speichern</button>
    <div id="notifArea" style="margin-top:11px"></div>
  </div>

  <!-- Kategorien -->
  <div class="card">
    <div class="sec-title">üè∑Ô∏è Kategorien</div>
    <div id="catsList"></div>
    <div style="display:flex;gap:7px;margin-top:11px">
      <input type="text" class="inp" id="catInp" placeholder="Kategorie hinzuf√ºgen‚Ä¶" style="margin:0;flex:1">
      <button class="btn btn-p" style="flex-shrink:0;padding:11px 16px" id="addCatBtn">+</button>
    </div>
  </div>

  <!-- L√§den -->
  <div class="card">
    <div class="sec-title">üè™ Meine L√§den</div>
    <div id="storesList"></div>
    <div style="display:flex;gap:7px;margin-top:11px">
      <input type="text" class="inp" id="storeInp" placeholder="Laden hinzuf√ºgen‚Ä¶" style="margin:0;flex:1">
      <button class="btn btn-p" style="flex-shrink:0;padding:11px 16px" id="addStoreBtn">+</button>
    </div>
  </div>

  <!-- Daten -->
  <div class="card">
    <div class="sec-title" style="color:var(--amber)">üì¶ Daten</div>
    <div style="display:flex;gap:7px;flex-wrap:wrap">
      <button class="btn btn-s btn-g" id="expBtn">üì• Export</button>
      <button class="btn btn-s btn-g" id="impBtn">üì§ Import</button>
      <button class="btn btn-s btn-r" id="clearBtn">üóëÔ∏è Alles l√∂schen</button>
    </div>
    <input type="file" id="impFile" accept=".json" style="display:none">
  </div>
</div>

<!-- BOTTOM NAV -->
<nav class="bnav" id="bnav" style="display:none">
  <button class="ni active" data-v="pantry"><span class="ni-icon">üè†</span><span>Vorrat</span></button>
  <button class="ni" data-v="scan"><span class="ni-icon">üì∑</span><span>Scannen</span></button>
  <button class="ni" data-v="shopping"><span class="ni-icon">üõçÔ∏è</span><span>Liste</span></button>
  <button class="ni" data-v="more"><span class="ni-icon">‚öôÔ∏è</span><span>Mehr</span></button>
</nav>
</div>

<!-- ADD ITEM MODAL -->
<div class="moverlay" id="addModal">
  <div class="msheet">
    <div class="mhandle"></div>
    <div class="sec-title">‚ûï Produkt hinzuf√ºgen</div>
    <label class="flabel">Name</label>
    <input type="text" class="inp" id="aName" placeholder="z.B. Milch, Eier, Brot‚Ä¶">
    <label class="flabel">Kategorie</label>
    <select class="inp" id="aCat"></select>
    <label class="flabel">Laden</label>
    <select class="inp" id="aStore"></select>
    <label class="flabel">Menge</label>
    <div style="display:flex;gap:7px;margin-bottom:11px">
      <input type="number" class="inp" id="aQty" placeholder="1" style="flex:1;margin:0" value="1" min="1">
      <input type="text" class="inp" id="aUnit" placeholder="St√ºck" style="flex:1;margin:0">
    </div>
    <label class="flabel">Status</label>
    <div style="display:flex;gap:7px;margin-bottom:15px">
      <button class="btn btn-s" id="saOk" style="flex:1;background:#d8f3dc;color:#1b4332;border:2px solid #52b788">‚úÖ Vorhanden</button>
      <button class="btn btn-s" id="saLow" style="flex:1;background:var(--bg);border:2px solid transparent">‚ö†Ô∏è Wenig</button>
      <button class="btn btn-s" id="saEmpty" style="flex:1;background:var(--bg);border:2px solid transparent">üî¥ Leer</button>
    </div>
    <div style="display:flex;gap:7px">
      <button class="btn btn-g" style="flex:1" onclick="closeModal()">Abbrechen</button>
      <button class="btn btn-p" style="flex:1" id="saveItemBtn">Speichern</button>
    </div>
  </div>
</div>


<!-- EDIT ITEM MODAL -->
<div class="moverlay" id="editModal">
  <div class="msheet">
    <div class="mhandle"></div>
    <div class="sec-title">‚úèÔ∏è Produkt bearbeiten</div>
    <label class="flabel">Name</label>
    <input type="text" class="inp" id="eName" placeholder="z.B. Milch, Eier, Brot‚Ä¶">
    <label class="flabel">Kategorie</label>
    <select class="inp" id="eCat"></select>
    <label class="flabel">Laden</label>
    <select class="inp" id="eStore"></select>
    <label class="flabel">Menge</label>
    <div style="display:flex;gap:7px;margin-bottom:11px">
      <input type="number" class="inp" id="eQty" style="flex:1;margin:0" value="1" min="1">
      <input type="text" class="inp" id="eUnit" placeholder="St√ºck" style="flex:1;margin:0">
    </div>
    <label class="flabel">Status</label>
    <div style="display:flex;gap:7px;margin-bottom:15px">
      <button class="btn btn-s" id="seOk" style="flex:1">‚úÖ Vorhanden</button>
      <button class="btn btn-s" id="seLow" style="flex:1">‚ö†Ô∏è Wenig</button>
      <button class="btn btn-s" id="seEmpty" style="flex:1">üî¥ Leer</button>
    </div>
    <div style="display:flex;gap:7px">
      <button class="btn btn-g" style="flex:1" onclick="closeEditModal()">Abbrechen</button>
      <button class="btn btn-p" style="flex:1" id="saveEditBtn">Speichern</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script>
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// CONSTANTS & STATE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SK = 'mv_state_v2', CK = 'mv_cfg_v2';
const STORE_COLORS = ['#1a3d2b','#2d6a4f','#52b788','#b8731a','#7c3aed','#b83232','#2563eb','#d97706'];
const DEFAULT_STORES = ['Billa','Lidl','Hofer','Spar','Rewe'];

let state = { items: [], stores: [...DEFAULT_STORES], categories: ['Obst & Gem√ºse','Milchprodukte','Fleisch & Fisch','Backwaren','Tiefk√ºhl','Getr√§nke','Haushalt','Sonstiges'], lastUpdated: null };
let cfg = { mode: null, scriptUrl: '', remDays: [3, 6], remTime: '09:00', notifOn: false, lastRemDate: '' };
let filterStore = 'all', newStatus = 'available', ocrItems = [], shopFilter = 'both';
let camStream = null, pushDebounce = null, syncing = false, autoSyncInterval = null;

function loadState() { try { const s = localStorage.getItem(SK); if (s) state = { ...state, ...JSON.parse(s) }; } catch(e){} }
function savState() { localStorage.setItem(SK, JSON.stringify(state)); }
function loadCfg()  { try { const c = localStorage.getItem(CK); if (c) cfg = { ...cfg, ...JSON.parse(c) }; } catch(e){} }
function savCfg()   { localStorage.setItem(CK, JSON.stringify(cfg)); }

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// GOOGLE SHEETS SYNC
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setSyncDot(status) {
  const d = document.getElementById('syncDot');
  d.className = 'sync-dot' + (status === 'syncing' ? ' syncing' : status === 'err' ? ' err' : '');
}

async function pullSheets(silent = false) {
  if (!cfg.scriptUrl) return false;
  setSyncDot('syncing');
  try {
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 8000); // 8 Sekunden Timeout
    const r = await fetch(cfg.scriptUrl, { method: 'GET', redirect: 'follow', signal: controller.signal });
    clearTimeout(timeout);
    if (!r.ok) throw new Error('HTTP ' + r.status);
    const remote = await r.json();
    if (remote.error) throw new Error(remote.error);
    // Nur updaten wenn Server neuer ist als lokaler Stand
    if (!state.lastUpdated || (remote.lastUpdated && remote.lastUpdated > state.lastUpdated)) {
      state = { ...state, ...remote };
      savState();
      renderAll(); // UI sofort aktualisieren wenn neue Daten da
      if (!silent) showToast('üîÑ Aktualisiert');
    }
    setSyncDot('ok');
    return true;
  } catch (e) {
    console.warn('Pull:', e.message);
    setSyncDot('err');
    if (!silent) showToast('‚ö†Ô∏è Sync fehlgeschlagen ‚Äì Offline-Modus aktiv');
    return false;
  }
}

// Auto-Pull alle 30 Sekunden im Hintergrund
function startAutoSync() {
  if (autoSyncInterval) clearInterval(autoSyncInterval);
  if (cfg.mode !== 'sheets' || !cfg.scriptUrl) return;
  autoSyncInterval = setInterval(() => {
    // Nur pollen wenn kein Push gerade l√§uft und kein pushDebounce wartet
    if (!syncing && !pushDebounce) pullSheets(true);
  }, 30000);
}

function stopAutoSync() {
  if (autoSyncInterval) { clearInterval(autoSyncInterval); autoSyncInterval = null; }
}

function schedulePush() {
  setSyncDot('syncing'); // sofortiges visuelles Feedback
  clearTimeout(pushDebounce);
  pushDebounce = setTimeout(() => { pushDebounce = null; pushSheets(); }, 800);
}

async function pushSheets() {
  if (cfg.mode !== 'sheets' || !cfg.scriptUrl || syncing) return;
  syncing = true; setSyncDot('syncing');
  state.lastUpdated = new Date().toISOString(); savState();
  try {
    const pushController = new AbortController();
    const pushTimeout = setTimeout(() => pushController.abort(), 10000);
    const r = await fetch(cfg.scriptUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify(state),
      redirect: 'follow',
      signal: pushController.signal
    });
    clearTimeout(pushTimeout);
    if (!r.ok) throw new Error('HTTP ' + r.status);
    const res = await r.json();
    if (!res.ok) throw new Error(res.error || 'Unbekannter Fehler');
    setSyncDot('ok');
  } catch (e) {
    console.warn('Push:', e.message);
    setSyncDot('err');
  } finally { syncing = false; }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// INIT
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function init() {
  initDark();
  loadCfg(); loadState();
  try { injectManifest(); } catch(e) { console.warn("manifest:", e); }
  try { setupEvents(); } catch(e) { console.warn("setupEvents error:", e); }

  // URL param: ?url=SCRIPT_URL (for easy sharing)
  const urlParam = new URLSearchParams(location.search).get('url');
  if (urlParam && urlParam !== cfg.scriptUrl) {
    cfg.scriptUrl = urlParam; cfg.mode = 'sheets'; savCfg();
  }

  if (cfg.mode === 'sheets' && cfg.scriptUrl) {
    showApp();
    await pullSheets();
    renderAll();
    startAutoSync();
  } else if (cfg.mode === 'offline') {
    showApp(); renderAll();
  } else {
    showView('setup'); // stays on setup
  }

  swSetup();
  checkRem();
}

function showApp() {
  document.getElementById('hdr').style.display = 'flex';
  document.getElementById('bnav').style.display = 'flex';
  document.getElementById('fab').style.display = 'flex';
  showView('pantry'); setNav('pantry');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// RENDER
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAll() { renderStats(); renderChips(); renderPantry(); renderShop(); renderStores(); renderCategories(); renderConnInfo(); }

function renderStats() {
  const c = { available: 0, low: 0, empty: 0 };
  state.items.forEach(i => c[i.status] = (c[i.status] || 0) + 1);
  document.getElementById('sOk').textContent = c.available;
  document.getElementById('sLow').textContent = c.low;
  document.getElementById('sEmpty').textContent = c.empty;
  document.getElementById('hdrSub').textContent = state.items.length + ' Produkte';
  // update shopping badge
  const need = state.items.filter(i => i.status !== 'available').length;
  document.querySelectorAll('.ni').forEach(b => {
    if (b.dataset.v === 'shopping') {
      let badge = b.querySelector('.badge');
      if (need > 0) {
        if (!badge) { badge = document.createElement('span'); badge.className = 'badge'; badge.style.cssText = 'position:absolute;top:6px;right:12px;background:var(--red);color:#fff;font-size:9px;min-width:16px;height:16px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:800'; b.appendChild(badge); }
        badge.textContent = need;
      } else if (badge) badge.remove();
    }
  });
}

function renderChips() {
  const box = document.getElementById('chips');
  box.innerHTML = `<div class="chip ${filterStore === 'all' ? 'active' : ''}" data-s="all">Alle</div>`;
  state.stores.forEach(s => {
    const c = document.createElement('div');
    c.className = 'chip' + (filterStore === s ? ' active' : '');
    c.dataset.s = s; c.textContent = 'üè™ ' + s;
    box.appendChild(c);
  });
  const usedCats = [...new Set(state.items.map(i => i.category).filter(Boolean))];
  usedCats.forEach(cat => {
    const c = document.createElement('div');
    c.className = 'chip' + (filterStore === 'cat:' + cat ? ' active' : '');
    c.dataset.s = 'cat:' + cat; c.textContent = 'üè∑Ô∏è ' + cat;
    box.appendChild(c);
  });
  box.querySelectorAll('.chip').forEach(c => c.addEventListener('click', () => { filterStore = c.dataset.s; renderChips(); renderPantry(); }));
}

function emoji(n) {
  const l = n.toLowerCase();
  if (/milch|milk/.test(l)) return 'ü•õ';
  if (/\bei\b|eier|egg/.test(l)) return 'ü•ö';
  if (/brot|bread|semmel|rolle|weckerl/.test(l)) return 'üçû';
  if (/butter|margarin/.test(l)) return 'üßà';
  if (/k√§se|cheese/.test(l)) return 'üßÄ';
  if (/joghurt|yogurt/.test(l)) return 'ü´ô';
  if (/apfel|apple/.test(l)) return 'üçé';
  if (/banane|banana/.test(l)) return 'üçå';
  if (/tomate/.test(l)) return 'üçÖ';
  if (/karotte|carrot/.test(l)) return 'ü•ï';
  if (/kartoffel|potato/.test(l)) return 'ü•î';
  if (/fleisch|hack|h√ºhn|chicken|schnitzel/.test(l)) return 'ü•©';
  if (/fisch|lachs|thun|fish/.test(l)) return 'üêü';
  if (/\breis\b|rice/.test(l)) return 'üçö';
  if (/nudel|pasta|spaghetti/.test(l)) return 'üçù';
  if (/√∂l|oil/.test(l)) return 'ü´í';
  if (/zucker|sugar/.test(l)) return 'üç¨';
  if (/mehl|flour/.test(l)) return 'üåæ';
  if (/kaffee|coffee/.test(l)) return '‚òï';
  if (/tee|tea/.test(l)) return 'üçµ';
  if (/saft|juice/.test(l)) return 'üßÉ';
  if (/\bwasser\b|water/.test(l)) return 'üíß';
  if (/wein|wine|bier|beer/.test(l)) return 'üç∫';
  if (/schokolade|chocolate|schoko/.test(l)) return 'üç´';
  if (/zwiebel|onion/.test(l)) return 'üßÖ';
  if (/knoblauch|garlic/.test(l)) return 'üßÑ';
  if (/salat|lettuce/.test(l)) return 'ü•ó';
  if (/wurst|salami|schinken/.test(l)) return 'üå≠';
  if (/shampoo|dusch/.test(l)) return 'üß¥';
  if (/klopapier|toilette|tissue/.test(l)) return 'üßª';
  if (/waschm/.test(l)) return 'üß∫';
  if (/sahne|cream/.test(l)) return 'ü•õ';
  if (/honig|honey/.test(l)) return 'üçØ';
  if (/chips|snack/.test(l)) return 'ü•®';
  if (/\beis\b/.test(l)) return 'üç¶';
  if (/pizza/.test(l)) return 'üçï';
  if (/m√ºsli|cornflakes|cerealien/.test(l)) return 'ü•£';
  return 'üõí';
}

function renderPantry() {
  const box = document.getElementById('pantryList');
  let items = filterStore === 'all' ? [...state.items] : filterStore.startsWith('cat:') ? state.items.filter(i => i.category === filterStore.slice(4)) : state.items.filter(i => i.store === filterStore);
  if (!items.length) {
    box.innerHTML = `<div class="empty"><div class="empty-i">üß∫</div><p>${filterStore === 'all' ? 'Noch keine Produkte.<br>Scanne deinen ersten Kassenbon!' : 'Keine Produkte f√ºr <strong>' + filterStore + '</strong>.'}</p></div>`;
    return;
  }
  const ord = { empty: 0, low: 1, available: 2 };
  items.sort((a, b) => ord[a.status] - ord[b.status] || a.name.localeCompare(b.name, 'de'));
  box.innerHTML = '';
  items.forEach(item => {
    const d = document.createElement('div');
    d.className = 'icard';
    d.innerHTML = `
      <div class="iicon">${emoji(item.name)}</div>
      <div class="iinfo">
        <div class="iname">${esc(item.name)}</div>
        <div class="imeta">
          ${item.category ? `<span style='font-size:10px;background:var(--bg);color:var(--muted);padding:1px 6px;border-radius:10px;font-weight:700'>${esc(item.category)}</span>` : ''}${item.store ? `<span>${esc(item.store)}</span><span>¬∑</span>` : ''}
          <span>${item.quantity || 1} ${esc(item.unit || 'St√ºck')}</span>
          <span class="sbadge ${item.status === 'available' ? 's-ok' : item.status === 'low' ? 's-low' : 's-empty'}">${slabel(item.status)}</span>
        </div>
      </div>
      <div class="iactions">
        <button class="sbtn sok" data-id="${item.id}" data-st="available" title="Vorhanden">‚úÖ</button>
        <button class="sbtn slow" data-id="${item.id}" data-st="low" title="Wenig">‚ö†Ô∏è</button>
        <button class="sbtn sgone" data-id="${item.id}" data-st="empty" title="Leer">üî¥</button>
        <button class="sbtn sedit" data-id="${item.id}" title="Bearbeiten" style="background:#e8f4f0;font-size:14px">‚úèÔ∏è</button>
        <button class="sbtn sdel" data-id="${item.id}" title="L√∂schen" style="background:#f8d7da;font-size:14px">üóëÔ∏è</button>
      </div>`;
    d.querySelectorAll('.sbtn').forEach(b => b.addEventListener('click', e => {
      e.stopPropagation();
      if (b.classList.contains('sdel')) delConfirm(b.dataset.id, item.name);
      else if (b.classList.contains('sedit')) openEditModal(item);
      else setStatus(b.dataset.id, b.dataset.st);
    }));
    box.appendChild(d);
  });
}

function renderShop() {
  const box = document.getElementById('shopList');
  let needs = state.items.filter(i => i.status !== 'available');
  if (shopFilter === 'low') needs = needs.filter(i => i.status === 'low');
  if (shopFilter === 'empty') needs = needs.filter(i => i.status === 'empty');
  if (!needs.length) { box.innerHTML = `<div class="empty"><div class="empty-i">üéâ</div><p>Alles vorhanden!<br>Dein Vorrat ist vollst√§ndig.</p></div>`; return; }
  const byStore = {};
  needs.forEach(i => { const s = i.store || 'Sonstiges'; if (!byStore[s]) byStore[s] = []; byStore[s].push(i); });
  box.innerHTML = '';
  Object.entries(byStore).forEach(([store, items]) => {
    const c = document.createElement('div'); c.className = 'card';
    c.innerHTML = `<div style="font-weight:800;font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;margin-bottom:9px">üè™ ${esc(store)}</div>`;
    items.forEach(item => {
      const r = document.createElement('div'); r.className = 'shoprow';
      const chk = item._chk || false;
      r.innerHTML = `<div class="shopcheck ${chk ? 'checked' : ''}" data-id="${item.id}">${chk ? '‚úì' : ''}</div>
        <div class="shopname ${chk ? 'done' : ''}">${esc(item.name)}</div>
        <span style="font-size:12px">${item.status === 'empty' ? 'üî¥' : '‚ö†Ô∏è'}</span>`;
      r.querySelector('.shopcheck').addEventListener('click', () => toggleChk(item.id));
      c.appendChild(r);
    });
    box.appendChild(c);
  });
}

function renderStores() {
  const box = document.getElementById('storesList');
  box.innerHTML = '';
  state.stores.forEach((s, i) => {
    const r = document.createElement('div'); r.className = 'strow';
    r.innerHTML = `<div class="stdot" style="background:${STORE_COLORS[i % STORE_COLORS.length]}"></div>
      <span style="flex:1;font-weight:600">${esc(s)}</span>
      <button style="background:none;border:none;color:var(--red);cursor:pointer;font-size:17px;padding:4px" data-s="${esc(s)}">‚úï</button>`;
    r.querySelector('button').addEventListener('click', () => rmStore(s));
    box.appendChild(r);
  });
  updSelects();
}


function renderCategories() {
  const box = document.getElementById('catsList'); if (!box) return;
  box.innerHTML = '';
  (state.categories || []).forEach((cat, i) => {
    const r = document.createElement('div'); r.className = 'strow';
    r.innerHTML = `<span style="font-size:16px">üè∑Ô∏è</span>
      <span style="flex:1;font-weight:600">${esc(cat)}</span>
      <button style="background:none;border:none;color:var(--red);cursor:pointer;font-size:17px;padding:4px" data-c="${esc(cat)}">‚úï</button>`;
    r.querySelector('button').addEventListener('click', () => {
      state.categories = state.categories.filter(x => x !== cat);
      savState(); schedulePush(); renderCategories(); updSelects(); renderChips();
    });
    box.appendChild(r);
  });
}

function renderConnInfo() {
  const box = document.getElementById('connInfo');
  if (!box) return;
  if (cfg.mode === 'sheets' && cfg.scriptUrl) {
    const short = cfg.scriptUrl.length > 50 ? cfg.scriptUrl.slice(0, 50) + '‚Ä¶' : cfg.scriptUrl;
    box.innerHTML = `<div class="conn-ok">‚úÖ Verbunden<br><span style="font-weight:400;font-size:10px;word-break:break-all">${esc(short)}</span></div>`;
  } else {
    box.innerHTML = `<div class="conn-err">‚ö†Ô∏è Nur lokaler Modus</div>`;
  }
}

function renderRemDays() {
  document.querySelectorAll('.daybtn').forEach(b => b.classList.toggle('sel', cfg.remDays.includes(+b.dataset.d)));
  document.getElementById('timeInp').value = cfg.remTime || '09:00';
}

function updSelects() {
  ['aStore', 'ocrStore', 'eStore'].forEach(id => {
    const el = document.getElementById(id); if (!el) return;
    const cur = el.value;
    el.innerHTML = state.stores.map(s => `<option value="${esc(s)}">${esc(s)}</option>`).join('');
    if (state.stores.includes(cur)) el.value = cur;
  });
  ['aCat', 'eCat'].forEach(id => {
    const el = document.getElementById(id); if (!el) return;
    const cur = el.value;
    el.innerHTML = '<option value="">‚Äî keine ‚Äî</option>' + state.categories.map(c => `<option value="${esc(c)}">${esc(c)}</option>`).join('');
    if (state.categories.includes(cur)) el.value = cur;
  });
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// DATA OPS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2, 6); }

function addItem(name, store, qty, unit, status, category) {
  const dup = state.items.find(i => i.name.toLowerCase() === name.toLowerCase() && i.store === store);
  if (dup) { dup.status = status; dup.quantity = qty; }
  else { state.items.push({ id: uid(), name: name.trim(), store, quantity: qty || 1, unit: unit || 'St√ºck', status: status || 'available', category: category || '', addedAt: new Date().toISOString(), _chk: false }); }
  savState(); schedulePush(); renderAll();
  showToast(dup ? `üîÑ "${name}" aktualisiert` : `‚úÖ "${name}" hinzugef√ºgt`);
}

function setStatus(id, status) {
  const i = state.items.find(x => x.id === id); if (!i) return;
  i.status = status; i.lastUpdated = new Date().toISOString();
  savState(); schedulePush(); renderAll();
}

function toggleChk(id) {
  const i = state.items.find(x => x.id === id); if (!i) return;
  i._chk = !i._chk; savState(); renderShop();
}

function rmStore(s) {
  state.stores = state.stores.filter(x => x !== s); savState(); schedulePush(); renderAll();
}


let editingId = null, editStatus = 'available';

function openEditModal(item) {
  editingId = item.id;
  editStatus = item.status;
  document.getElementById('eName').value = item.name;
  document.getElementById('eQty').value = item.quantity || 1;
  document.getElementById('eUnit').value = item.unit || 'St√ºck';
  updSelects();
  document.getElementById('eStore').value = item.store || '';
  document.getElementById('eCat').value = item.category || '';
  updEditStatusBtns();
  document.getElementById('editModal').classList.add('open');
}

function closeEditModal() {
  document.getElementById('editModal').classList.remove('open');
  editingId = null;
}

function updEditStatusBtns() {
  const bg = { available: '#d8f3dc', low: '#fff3cd', empty: '#f8d7da' };
  const border = { available: '#52b788', low: '#ffc107', empty: '#dc3545' };
  ['seOk','seLow','seEmpty'].forEach(id => {
    const s = {seOk:'available',seLow:'low',seEmpty:'empty'}[id];
    const b = document.getElementById(id); if (!b) return;
    b.style.background = editStatus === s ? bg[s] : 'var(--bg)';
    b.style.border = editStatus === s ? `2px solid ${border[s]}` : '2px solid transparent';
  });
}

function delConfirm(id, name) {
  if (confirm(`"${name}" wirklich l√∂schen?`)) {
    state.items = state.items.filter(i => i.id !== id); savState(); schedulePush(); renderAll(); showToast(`üóëÔ∏è "${name}" gel√∂scht`);
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// CAMERA / OCR
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function openCam() {
  try {
    camStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 1280 } } });
    const v = document.getElementById('cameraPreview'); v.srcObject = camStream; v.style.display = 'block';
    document.getElementById('scanBtns').style.display = 'none';
    document.getElementById('camCtrl').style.display = 'block';
  } catch (e) { showToast('‚ùå Kamera nicht verf√ºgbar'); document.getElementById('fileInp').click(); }
}

function snap() {
  const v = document.getElementById('cameraPreview'), c = document.getElementById('capturedCanvas');
  c.width = v.videoWidth; c.height = v.videoHeight;
  c.getContext('2d').drawImage(v, 0, 0); c.style.display = 'block';
  v.style.display = 'none'; stopCam();
  document.getElementById('camCtrl').style.display = 'none';
  preprocessCanvas(c);
  runOcr(c);
}

function stopCam() { if (camStream) { camStream.getTracks().forEach(t => t.stop()); camStream = null; } }

function cancelCam() {
  stopCam();
  document.getElementById('cameraPreview').style.display = 'none';
  document.getElementById('camCtrl').style.display = 'none';
  document.getElementById('scanBtns').style.display = 'flex';
}

async function fileToCanvas(file) {
  const c = document.getElementById('capturedCanvas'), img = new Image(), url = URL.createObjectURL(file);
  await new Promise(res => { img.onload = () => { c.width = img.naturalWidth; c.height = img.naturalHeight; c.getContext('2d').drawImage(img, 0, 0); URL.revokeObjectURL(url); res(); }; img.src = url; });
  c.style.display = 'block';
  preprocessCanvas(c);
  runOcr(c);
}

// ‚îÄ‚îÄ Bildvorverarbeitung f√ºr bessere OCR-Ergebnisse ‚îÄ‚îÄ
// Kassenbon-Bons sind oft verblasst, schief fotografiert und klein gedruckt.
// Diese Funktion macht das Bild sch√§rfer, erh√∂ht den Kontrast und konvertiert
// in Schwarz-Wei√ü ‚Äì das erh√∂ht die Tesseract-Erkennungsrate deutlich.
function preprocessCanvas(canvas) {
  const ctx = canvas.getContext('2d');
  const w = canvas.width, h = canvas.height;

  // 1. Auf max. 2000px begrenzen (zu hohe Aufl√∂sung verlangsamt OCR)
  if (w > 2000 || h > 2000) {
    const scale = Math.min(2000 / w, 2000 / h);
    const tmp = document.createElement('canvas');
    tmp.width = Math.round(w * scale); tmp.height = Math.round(h * scale);
    tmp.getContext('2d').drawImage(canvas, 0, 0, tmp.width, tmp.height);
    canvas.width = tmp.width; canvas.height = tmp.height;
    ctx.drawImage(tmp, 0, 0);
  }

  // 2. Pixeldaten holen
  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const data = imageData.data;

  for (let i = 0; i < data.length; i += 4) {
    // Graustufen (Luminanz-Formel)
    const gray = 0.299 * data[i] + 0.587 * data[i+1] + 0.114 * data[i+2];

    // Kontrast erh√∂hen (S-Kurve)
    const contrast = 1.8;
    const factor = (259 * (contrast * 255 + 255)) / (255 * (259 - contrast * 255));
    let c = factor * (gray - 128) + 128;

    // Adaptiver Schwellenwert ‚Üí Schwarz/Wei√ü
    // Heller als 140 ‚Üí wei√ü (Hintergrund), dunkler ‚Üí schwarz (Text)
    c = Math.max(0, Math.min(255, c));

    data[i] = data[i+1] = data[i+2] = c;
    // Alpha unver√§ndert lassen
  }

  ctx.putImageData(imageData, 0, 0);
}

async function runOcr(canvas) {
  document.getElementById('ocrProg').style.display = 'block';
  document.getElementById('ocrResults').style.display = 'none';
  setOcrText('üîç Starte Analyse‚Ä¶', 5);
  try {
    const worker = await Tesseract.createWorker('deu', 1, {
      logger: m => {
        if (m.status === 'loading tesseract core') setOcrText('‚öôÔ∏è Lade OCR-Engine‚Ä¶', 10);
        if (m.status === 'initializing tesseract') setOcrText('‚öôÔ∏è Initialisiere‚Ä¶', 20);
        if (m.status === 'loading language traineddata') setOcrText('üìñ Lade Sprachdaten‚Ä¶', 35);
        if (m.status === 'recognizing text') {
          const p = Math.round(40 + (m.progress || 0) * 55);
          setOcrText(`üîç Lese Text‚Ä¶ ${p}%`, p);
        }
      }
    });

    // PSM 6 = gleichm√§√üiger Textblock ‚Äì gut f√ºr Kassenbons aller Arten
    await worker.setParameters({
      tessedit_pageseg_mode: '6',
    });

    const { data: { text } } = await worker.recognize(canvas);
    await worker.terminate();
    setOcrText('‚úÖ Fertig!', 100);
    setTimeout(() => { document.getElementById('ocrProg').style.display = 'none'; }, 400);
    parseReceipt(text);
  } catch (e) {
    document.getElementById('ocrProg').style.display = 'none';
    console.error('OCR Error:', e);
    showToast('‚ùå OCR fehlgeschlagen ‚Äì bitte manuell eingeben');
  }
}

function setOcrText(txt, pct) {
  document.getElementById('ocrTxt').textContent = txt;
  document.getElementById('ocrFill').style.width = pct + '%';
}

function detectStore(text) {
  const lower = text.toLowerCase();
  const storeMap = [
    ['aldi', 'Aldi'], ['rewe', 'Rewe'], ['lidl', 'Lidl'], ['penny', 'Penny'],
    ['billa', 'Billa'], ['spar', 'Spar'], ['hofer', 'Hofer'], ['edeka', 'Edeka'],
    ['netto', 'Netto'], ['kaufland', 'Kaufland'], ['real', 'Real'],
    ['dm ', 'dm'], ['rossmann', 'Rossmann'], ['m√ºller', 'M√ºller'],
    ['tegut', 'tegut'], ['norma', 'Norma'], ['nahkauf', 'Nahkauf']
  ];
  for (const [key, name] of storeMap) {
    if (lower.includes(key)) return name;
  }
  return null;
}

function parseReceipt(text) {
  // Laden automatisch erkennen
  const detectedStore = detectStore(text);
  if (detectedStore && state.stores.includes(detectedStore)) {
    document.getElementById('ocrStore').value = detectedStore;
  }
  // Zeilen die definitiv keine Produkte sind
  const skipPatterns = [
    /^(mwst|ust|mehrwert|summe|total|gesamt|zwischen|bar |bargeld|r√ºckgabe|r√ºckgeld|wechselgeld|bezahlt|zahlung|kasse|bon|beleg|danke|subtotal|datum|√∂ffnung|filiale|kassier|bedien|vielen|wiedersehen|artikel|normalpreis)/i,
    /^\d{1,2}[\.\/]\d{1,2}[\.\/]\d{2,4}(\s|$)/,   // Datum
    /^\d{2}:\d{2}/,                                  // Uhrzeit
    /^\d+[,\.]\d{2}\s*[A-Da-d]?\s*$/,               // Nur Preis
    /^[^a-zA-Z√§√∂√º√Ñ√ñ√ú√ü]*$/,                          // Keine Buchstaben
    /\d+[,\.]\d+\s*(EUR\/kg|EUR\/l|EUR\/St)/i,       // Gewichtspreis-Zeilen
    /^[ABCabc]\s+\d+[,\.]\d+\s*%/,                  // Steuerklassen-Zeilen
    /netto|brutto|steuer|inkl\.|exkl\./i,
  ];

  // Produktzeilen-Muster: REWE-Stil hat kein Pr√§fix, tegut hat Preise am Ende
  const lines = text
    .split('\n')
    .map(l => l.trim())
    .filter(l => {
      if (l.length < 3) return false;
      // Muss mindestens 3 aufeinanderfolgende Buchstaben haben
      if (!/[a-zA-Z√§√∂√º√Ñ√ñ√ú√ü]{3,}/.test(l)) return false;
      if (skipPatterns.some(p => p.test(l))) return false;
      // Zeilen die fast nur Sonderzeichen/Zahlen sind ‚Üí weg
      const letterCount = (l.match(/[a-zA-Z√§√∂√º√Ñ√ñ√ú√ü]/g) || []).length;
      if (letterCount < 3) return false;
      return true;
    });

  const seen = new Set();
  ocrItems = lines.map(l => {
    let n = l
      // F√ºhrende Sonderzeichen & Pipes entfernen: "| BIO Basilikum" ‚Üí "BIO Basilikum"
      .replace(/^[\|\[\]\{\}\,\.\!\?\;\:'"\¬£\$\‚Ç¨\#\*\+\-\_\/\\]+\s*/, '')
      // Artikelnummer am Anfang (ALDI/Lidl): "43468 Produkt" ‚Üí "Produkt"
      .replace(/^\d{4,7}\s+/, '')
      // Menge am Anfang: "2 x ", "3x "
      .replace(/^\d+\s*[xX]\s+/, '')
      // Preise + Steuerklasse am Ende: "2,99 C" oder "1,49 A" oder "3,30"
      .replace(/\s+\d+[,\.]\d{2}\s*[A-Ca-c]?\s*$/, '')
      // EUR/kg Preisangaben in der Mitte: "0,624 kg x 3,99 EUR/kg"
      .replace(/\d+[,\.]\d+\s*kg\s*x\s*\d+[,\.]\d+\s*EUR\/kg/gi, '')
      // Gewichtsangaben: "125g", "200 g", "1kg", "0,5 l"
      .replace(/\d+[,\.]?\d*\s*(kg|g|l|ml|cl|stk\.?)/gi, '')
      // EUR-Preise irgendwo: "9,99 EUR"  
      .replace(/\d+[,\.]\d+\s*EUR\s*/gi, '')
      // Tailing Sonderzeichen
      .replace(/[\|\[\]\{\}\)\(\!\?\;\:]+\s*$/, '')
      // Mehrfache Leerzeichen
      .replace(/\s{2,}/g, ' ')
      .trim();

    // Nach Bereinigung zu kurz oder immer noch kein echter Text
    if (n.length < 3 || !/[a-zA-Z√§√∂√º√Ñ√ñ√ú√ü]{3,}/.test(n)) return null;

    // Zeilen die nach Bereinigung haupts√§chlich Zahlen/Sonderzeichen sind
    const letters = (n.match(/[a-zA-Z√§√∂√º√Ñ√ñ√ú√ü]/g) || []).length;
    if (letters < 3) return null;

    // Alles-Gro√übuchstaben normalisieren: "VOLLMILCH" ‚Üí "Vollmilch"
    const letters_only = n.replace(/[^a-zA-Z√§√∂√º√Ñ√ñ√ú√ü]/g, '');
    if (letters_only === letters_only.toUpperCase() && letters_only.length > 2) {
      n = n.charAt(0).toUpperCase() + n.slice(1).toLowerCase();
    }
    n = n.charAt(0).toUpperCase() + n.slice(1);

    // Duplikate (Buchstaben-normalisiert vergleichen)
    const key = n.toLowerCase().replace(/[^a-z√§√∂√º√ü]/g, '');
    if (key.length < 3 || seen.has(key)) return null;
    seen.add(key);

    return { id: uid(), name: n, sel: true };
  }).filter(Boolean);

  if (!ocrItems.length) {
    showToast('‚ö†Ô∏è Keine Produkte erkannt');
    document.getElementById('ocrResults').style.display = 'block';
    document.getElementById('ocrList').innerHTML = `
      <div style="text-align:center;padding:20px;color:var(--muted)">
        <div style="font-size:36px;margin-bottom:8px">üì∑</div>
        <p style="font-size:13px;line-height:1.5">Nichts erkannt.<br>Tipps: <strong>helles Licht</strong>, Bon <strong>gerade</strong> halten, <strong>nah genug</strong> ran.</p>
      </div>`;
    updSelects();
    return;
  }

  renderOcrItems();
  document.getElementById('ocrResults').style.display = 'block';
  updSelects();
  showToast(`üîç ${ocrItems.length} Produkte erkannt ‚Äì bitte pr√ºfen`);
}


function renderOcrItems() {
  const box = document.getElementById('ocrList'); box.innerHTML = '';
  ocrItems.forEach((item, i) => {
    const r = document.createElement('div'); r.className = 'ocrrow';
    r.innerHTML = `<div class="ocrtog ${item.sel ? 'sel' : ''}" data-i="${i}">${item.sel ? '‚úì' : ''}</div>
      <div class="ocrname"><input type="text" value="${esc(item.name)}" data-i="${i}"></div>`;
    r.querySelector('.ocrtog').addEventListener('click', () => { ocrItems[i].sel = !ocrItems[i].sel; r.querySelector('.ocrtog').className = 'ocrtog' + (ocrItems[i].sel ? ' sel' : ''); r.querySelector('.ocrtog').textContent = ocrItems[i].sel ? '‚úì' : ''; });
    r.querySelector('input').addEventListener('change', e => ocrItems[i].name = e.target.value);
    box.appendChild(r);
  });
}

function doAddOcr() {
  const store = document.getElementById('ocrStore').value;
  let n = 0;
  ocrItems.filter(i => i.sel && i.name.trim()).forEach(item => {
    const dup = state.items.find(x => x.name.toLowerCase() === item.name.toLowerCase());
    if (dup) { dup.status = 'available'; } else { state.items.push({ id: uid(), name: item.name.trim(), store, quantity: 1, unit: 'St√ºck', status: 'available', addedAt: new Date().toISOString(), _chk: false }); }
    n++;
  });
  savState(); schedulePush(); renderAll();
  document.getElementById('ocrResults').style.display = 'none';
  document.getElementById('capturedCanvas').style.display = 'none';
  document.getElementById('scanBtns').style.display = 'flex';
  ocrItems = [];
  showToast(`‚úÖ ${n} Produkte hinzugef√ºgt`);
  showView('pantry'); setNav('pantry');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// REMINDERS / SERVICE WORKER
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function swSetup() {
  if (!('serviceWorker' in navigator)) return;
  try { await navigator.serviceWorker.register('./sw.js'); } catch (e) { console.log('SW:', e.message); }
}

async function reqNotif() {
  if (!('Notification' in window)) { showToast('‚ö†Ô∏è Benachrichtigungen nicht unterst√ºtzt'); return; }
  const p = await Notification.requestPermission();
  cfg.notifOn = p === 'granted'; savCfg(); updNotifUI();
  showToast(p === 'granted' ? 'üîî Benachrichtigungen aktiviert!' : '‚ö†Ô∏è Benachrichtigungen abgelehnt ‚Äì bitte in Browser-Einstellungen erlauben');
}

function checkRem() {
  if (!cfg.notifOn || !cfg.remDays.length) return;
  if (typeof Notification === 'undefined' || Notification.permission !== 'granted') return;
  const now = new Date(), day = now.getDay(), today = now.toDateString();
  if (!cfg.remDays.includes(day) || cfg.lastRemDate === today) return;
  const [h] = (cfg.remTime || '09:00').split(':').map(Number);
  if (now.getHours() < h) return;
  cfg.lastRemDate = today; savCfg();
  setTimeout(() => new Notification('ü•ò Mein Vorrat', { body: 'Zeit den Vorratsstatus zu aktualisieren! Was wurde verbraucht?', tag: 'mv-rem' }), 800);
}

function updNotifUI() {
  const a = document.getElementById('notifArea'); if (!a) return;
  if (typeof Notification !== 'undefined' && Notification.permission === 'granted') {
    a.innerHTML = `<div style="display:flex;align-items:center;gap:8px;padding:10px;background:#d8f3dc;border-radius:9px;font-size:12px;font-weight:700;color:#1b4332">‚úÖ Benachrichtigungen aktiv</div>`;
  } else {
    a.innerHTML = `<button class="btn btn-a btn-w" id="notifBtn">üîî Benachrichtigungen aktivieren</button>`;
    document.getElementById('notifBtn').addEventListener('click', reqNotif);
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// NAVIGATION
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showView(n) {
  document.querySelectorAll('.view').forEach(v => v.classList.toggle('active', v.id === `view-${n}`));
}
function setNav(n) { document.querySelectorAll('.ni').forEach(b => b.classList.toggle('active', b.dataset.v === n)); }

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// HELPERS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function slabel(s) { return { available: '‚úÖ Da', low: '‚ö†Ô∏è Wenig', empty: 'üî¥ Leer' }[s] || s; }
function esc(s) { const d = document.createElement('div'); d.appendChild(document.createTextNode(String(s || ''))); return d.innerHTML; }
function openModal() { updSelects(); document.getElementById('addModal').classList.add('open'); }
function closeModal() { document.getElementById('addModal').classList.remove('open'); }
let toastT;
function showToast(m) { const t = document.getElementById('toast'); t.textContent = m; t.classList.add('show'); clearTimeout(toastT); toastT = setTimeout(() => t.classList.remove('show'), 2800); }

function updStatusBtns() {
  const bg = { available: '#d8f3dc', low: '#fff3cd', empty: '#f8d7da' };
  const border = { available: '#52b788', low: '#ffc107', empty: '#dc3545' };
  ['saOk', 'saLow', 'saEmpty'].forEach(id => {
    const s = { saOk: 'available', saLow: 'low', saEmpty: 'empty' }[id], b = document.getElementById(id);
    b.style.background = newStatus === s ? bg[s] : 'var(--bg)';
    b.style.border = newStatus === s ? `2px solid ${border[s]}` : '2px solid transparent';
  });
}

function shareShop() {
  const needs = state.items.filter(i => i.status !== 'available');
  if (!needs.length) { showToast('üéâ Alles vorhanden!'); return; }
  const byStore = {};
  needs.forEach(i => { const s = i.store || 'Sonstiges'; if (!byStore[s]) byStore[s] = []; byStore[s].push(i); });
  let txt = 'üõí Einkaufsliste ‚Äì Mein Vorrat\n\n';
  Object.entries(byStore).forEach(([s, its]) => { txt += `üìç ${s}:\n`; its.forEach(i => txt += `  ${i.status === 'empty' ? 'üî¥' : '‚ö†Ô∏è'} ${i.name}\n`); txt += '\n'; });
  if (navigator.share) navigator.share({ title: 'Einkaufsliste', text: txt });
  else navigator.clipboard.writeText(txt).then(() => showToast('üìã Liste kopiert!'));
}

function expData() {
  const b = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(b);
  a.download = `mein-vorrat-${new Date().toISOString().slice(0, 10)}.json`; a.click();
}
function impData(file) {
  const r = new FileReader(); r.onload = e => {
    try { const d = JSON.parse(e.target.result); if (d.items) { state = { ...state, ...d }; savState(); schedulePush(); renderAll(); showToast(`‚úÖ ${d.items.length} Produkte importiert`); } }
    catch (e) { showToast('‚ùå Ung√ºltige Datei'); }
  }; r.readAsText(file);
}

function getShareUrl() {
  if (cfg.mode !== 'sheets' || !cfg.scriptUrl) return null;
  return `${location.origin}${location.pathname}?url=${encodeURIComponent(cfg.scriptUrl)}`;
}

function injectManifest() {
  const m = { name: 'Mein Vorrat', short_name: 'Vorrat', start_url: location.pathname + (location.search || ''), display: 'standalone', background_color: '#F4EFE6', theme_color: '#1a3d2b', icons: [{ src: 'https://em-content.zobj.net/source/google/387/seedling_1f331.png', sizes: '512x512', type: 'image/png' }] };
  document.getElementById('manifest-placeholder').href = URL.createObjectURL(new Blob([JSON.stringify(m)], { type: 'application/json' }));
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// EVENTS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setupEvents() {
  // Nav
  document.querySelectorAll('.ni').forEach(b => b.addEventListener('click', () => {
    const v = b.dataset.v; showView(v); setNav(v);
    if (v === 'more') { renderRemDays(); renderStores(); renderCategories(); updNotifUI(); renderConnInfo(); }
    if (v === 'shopping') renderShop();
    if (v === 'scan') { cancelCam(); document.getElementById('capturedCanvas').style.display = 'none'; document.getElementById('ocrResults').style.display = 'none'; document.getElementById('ocrProg').style.display = 'none'; document.getElementById('scanBtns').style.display = 'flex'; }
  }));

  document.getElementById('hdrBtn').addEventListener('click', () => { showView('more'); setNav('more'); renderRemDays(); renderStores(); updNotifUI(); renderConnInfo(); });
  document.getElementById('fab').addEventListener('click', () => { newStatus = 'available'; updStatusBtns(); updSelects(); openModal(); });

  // Save item
  document.getElementById('saveItemBtn').addEventListener('click', () => {
    const name = document.getElementById('aName').value.trim();
    if (!name) { showToast('‚ùå Bitte Namen eingeben'); return; }
    addItem(name, document.getElementById('aStore').value, +document.getElementById('aQty').value || 1, document.getElementById('aUnit').value.trim() || 'St√ºck', newStatus, document.getElementById('aCat').value);
    document.getElementById('aName').value = ''; document.getElementById('aQty').value = '1'; document.getElementById('aUnit').value = '';
    closeModal();
  });
  ['saOk', 'saLow', 'saEmpty'].forEach(id => document.getElementById(id).addEventListener('click', () => { newStatus = { saOk: 'available', saLow: 'low', saEmpty: 'empty' }[id]; updStatusBtns(); }));
  document.getElementById('addModal').addEventListener('click', e => { if (e.target === document.getElementById('addModal')) closeModal(); });

  // Scan
  document.getElementById('camBtn').addEventListener('click', openCam);
  document.getElementById('snapBtn').addEventListener('click', snap);
  document.getElementById('camCancelBtn').addEventListener('click', cancelCam);
  document.getElementById('fileBtn').addEventListener('click', () => document.getElementById('fileInp').click());
  document.getElementById('fileInp').addEventListener('change', e => { if (e.target.files[0]) fileToCanvas(e.target.files[0]); });
  document.getElementById('ocrAdd').addEventListener('click', doAddOcr);
  document.getElementById('ocrCancel').addEventListener('click', () => { document.getElementById('ocrResults').style.display = 'none'; document.getElementById('capturedCanvas').style.display = 'none'; document.getElementById('scanBtns').style.display = 'flex'; ocrItems = []; });

  // Shopping
  document.getElementById('fAll').addEventListener('click', () => { shopFilter = 'both'; renderShop(); });
  document.getElementById('fLow').addEventListener('click', () => { shopFilter = 'low'; renderShop(); });
  document.getElementById('fEmpty').addEventListener('click', () => { shopFilter = 'empty'; renderShop(); });
  document.getElementById('clearChecked').addEventListener('click', () => { state.items.forEach(i => i._chk = false); savState(); renderShop(); });
  document.getElementById('shareListBtn').addEventListener('click', shareShop);

  // Reminders
  document.querySelectorAll('.daybtn').forEach(b => b.addEventListener('click', () => {
    const d = +b.dataset.d, idx = cfg.remDays.indexOf(d);
    if (idx >= 0) cfg.remDays.splice(idx, 1); else cfg.remDays.push(d);
    renderRemDays();
  }));
  document.getElementById('saveRemBtn').addEventListener('click', () => {
    cfg.remTime = document.getElementById('timeInp').value; savCfg(); showToast('üíæ Erinnerungen gespeichert');
    if (!cfg.notifOn) reqNotif();
  });

  // Stores
  document.getElementById('addStoreBtn').addEventListener('click', () => {
    const n = document.getElementById('storeInp').value.trim();
    if (!n || state.stores.includes(n)) return;
    state.stores.push(n); savState(); schedulePush(); renderAll();
    document.getElementById('storeInp').value = ''; showToast(`üè™ "${n}" hinzugef√ºgt`);
  });
  document.getElementById('storeInp').addEventListener('keydown', e => { if (e.key === 'Enter') document.getElementById('addStoreBtn').click(); });

  // Connect button handled via onclick in HTML (doConnect / doOffline)
  // offlineBtn handled via onclick

  // More ‚Äì connection actions
  // Edit modal
  document.getElementById('editModal').addEventListener('click', e => { if (e.target === document.getElementById('editModal')) closeEditModal(); });
  ['seOk','seLow','seEmpty'].forEach(id => {
    const b = document.getElementById(id); if (!b) return;
    b.addEventListener('click', () => { editStatus = {seOk:'available',seLow:'low',seEmpty:'empty'}[id]; updEditStatusBtns(); });
  });
  const saveEdit = document.getElementById('saveEditBtn');
  if (saveEdit) saveEdit.addEventListener('click', () => {
    if (!editingId) return;
    const item = state.items.find(x => x.id === editingId); if (!item) return;
    item.name = document.getElementById('eName').value.trim() || item.name;
    item.store = document.getElementById('eStore').value;
    item.category = document.getElementById('eCat').value;
    item.quantity = +document.getElementById('eQty').value || 1;
    item.unit = document.getElementById('eUnit').value.trim() || 'St√ºck';
    item.status = editStatus;
    savState(); schedulePush(); renderAll();
    closeEditModal(); showToast('‚úÖ Gespeichert');
  });

  // Categories
  const addCatBtn = document.getElementById('addCatBtn');
  if (addCatBtn) addCatBtn.addEventListener('click', () => {
    const n = document.getElementById('catInp').value.trim();
    if (!n || state.categories.includes(n)) return;
    state.categories.push(n); savState(); schedulePush();
    renderCategories(); updSelects();
    document.getElementById('catInp').value = '';
    showToast('üè∑Ô∏è "' + n + '" hinzugef√ºgt');
  });

  document.getElementById('syncNowBtn').addEventListener('click', async () => { showToast('üîÑ Synchronisiere‚Ä¶'); await pullSheets(); renderAll(); showToast('‚úÖ Synchronisiert'); });
  document.getElementById('copyShareBtn').addEventListener('click', () => {
    const url = getShareUrl();
    if (url) navigator.clipboard.writeText(url).then(() => showToast('üìã Teilen-Link kopiert!')).catch(() => showToast('‚ùå Kopieren fehlgeschlagen'));
    else showToast('‚ö†Ô∏è Kein Sheets-Modus aktiv');
  });
  document.getElementById('disconnBtn').addEventListener('click', () => {
    if (confirm('Verbindung trennen? Lokale Daten bleiben erhalten.')) {
      cfg.mode = 'offline'; savCfg(); showToast('Verbindung getrennt'); renderConnInfo();
    }
  });

  // Data
  document.getElementById('expBtn').addEventListener('click', expData);
  document.getElementById('impBtn').addEventListener('click', () => document.getElementById('impFile').click());
  document.getElementById('impFile').addEventListener('change', e => { if (e.target.files[0]) impData(e.target.files[0]); });
  document.getElementById('clearBtn').addEventListener('click', () => {
    if (confirm('Wirklich ALLE Produkte l√∂schen?')) { state.items = []; savState(); schedulePush(); renderAll(); showToast('üóëÔ∏è Alle Produkte gel√∂scht'); }
  });
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// SETUP ACTIONS ‚Äì standalone so they work even if setupEvents() crashes
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function toggleDark() {
  const isDark = document.documentElement.getAttribute('data-dark') === '1';
  document.documentElement.setAttribute('data-dark', isDark ? '0' : '1');
  localStorage.setItem('mv_dark', isDark ? '0' : '1');
  document.getElementById('darkBtn').textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
}

function initDark() {
  const saved = localStorage.getItem('mv_dark');
  const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  const dark = saved !== null ? saved === '1' : prefersDark;
  document.documentElement.setAttribute('data-dark', dark ? '1' : '0');
  const btn = document.getElementById('darkBtn');
  if (btn) btn.textContent = dark ? '‚òÄÔ∏è' : 'üåô';
}

function doConnect() {
  const inp = document.getElementById('scriptUrl');
  if (!inp) return;
  const url = inp.value.trim();
  if (!url) { showToast('‚ùå Bitte URL eingeben'); return; }
  cfg.scriptUrl = url; cfg.mode = 'sheets'; savCfg();
  showApp(); renderAll(); startAutoSync();
  showToast('‚úÖ Verbunden! Daten werden geladen‚Ä¶');
}

function doOffline() {
  cfg.mode = 'offline'; savCfg();
  showApp(); renderAll();
  showToast('üì± Lokaler Modus aktiv');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// START
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// Wenn User App wieder in den Vordergrund bringt ‚Üí sofort einmal pullen
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'visible' && cfg.mode === 'sheets') {
    pullSheets(true);
  }
});

init();
</script>
</body>
</html>
